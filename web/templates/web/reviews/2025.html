{% extends 'web/_base_bootstrap.html' %}

{% block title %}Year in review 2025 - RideHub{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="text-center mb-5">
        <h1 class="display-3 fw-bold mb-3">ðŸš´ 2025 year in review</h1>
        <p class="lead text-muted">A look back at an incredible year of riding together</p>
    </div>

    <section class="mb-5">
        <h2 class="h3 fw-bold mb-4 pb-2 border-bottom">The big numbers</h2>
        <div class="row g-4 mb-3">
        <div class="col-md-6 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center p-4">
                    <div class="display-3 fw-bold text-primary mb-2">{{ stats.total_events }}</div>
                    <h5 class="text-muted mb-0">Events held</h5>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center p-4">
                    <div class="display-3 fw-bold text-success mb-2">{{ stats.total_registrations }}</div>
                    <h5 class="text-muted mb-0">Total registrations</h5>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center p-4">
                    <div class="display-3 fw-bold text-info mb-2">{{ stats.unique_participants }}</div>
                    <h5 class="text-muted mb-0">Unique riders</h5>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center p-4">
                    <div class="display-3 fw-bold text-warning mb-2">{{ stats.total_distance|floatformat:0 }}</div>
                    <h5 class="text-muted mb-0">Total kilometers</h5>
                </div>
            </div>
        </div>

        <div class="col-md-6 col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-body text-center p-4">
                    <div class="display-3 fw-bold text-danger mb-2">{{ stats.total_elevation|floatformat:0 }}</div>
                    <h5 class="text-muted mb-0">Total elevation gain (m)</h5>
                </div>
            </div>
        </div>

        <div class="alert alert-light border mt-3">
            <strong>How we calculated:</strong>
            <ul class="mb-0 small">
                <li><strong>Total Kilometers:</strong> Sum of all confirmed registrations Ã— route distance</li>
                <li><strong>Total Elevation Gain:</strong> Sum of all confirmed registrations Ã— route elevation gain</li>
                <li><strong>Unique Riders:</strong> Count of distinct participants with confirmed registrations</li>
            </ul>
        </div>
    </section>

    <section class="mb-5">
        <h2 class="h3 fw-bold mb-4 pb-2 border-bottom">Ride leader recognition</h2>
        <div class="row g-4 mb-3">
            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body text-center p-4">
                        <div class="display-4 fw-bold text-success mb-2">{{ stats.total_ride_leaders }}</div>
                        <h5 class="text-muted mb-0">Total ride leaders</h5>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body text-center p-4">
                        <div class="display-4 fw-bold text-info mb-2">{{ stats.total_ride_leader_slots }}</div>
                        <h5 class="text-muted mb-0">Times led</h5>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body text-center p-4">
                        <div class="display-4 fw-bold text-warning mb-2">{{ stats.dedicated_leaders }}</div>
                        <h5 class="text-muted mb-0">Dedicated leaders</h5>
                        <p class="small text-muted mb-0">(5+ rides)</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-success border-success">
            <p class="mb-0">
                <strong>Thank you to our volunteers!</strong> Our ride leaders make every event possible.
                {{ stats.total_ride_leaders }} riders stepped up to lead rides throughout 2025,
                with {{ stats.dedicated_leaders }} dedicated leaders showing up week after week.
            </p>
        </div>

        <div class="alert alert-light border mt-3">
            <strong>How we calculated:</strong>
            <ul class="mb-0 small">
                <li><strong>Total Ride Leaders:</strong> Unique riders who volunteered as ride leaders at confirmed events</li>
                <li><strong>Times Led:</strong> Total number of ride leader slots filled across all events</li>
                <li><strong>Dedicated Leaders:</strong> Riders who led 5 or more rides during the year</li>
            </ul>
        </div>
    </section>

    <section class="mb-5">
        <h2 class="h3 fw-bold mb-4 pb-2 border-bottom">Monthly trends</h2>
        <div class="row g-4 mb-3">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <h3 class="fs-5 fw-medium mb-3">Events by program</h3>
                        <canvas id="monthlyEventsChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <h3 class="fs-5 fw-medium mb-3">Registrations by program</h3>
                        <canvas id="monthlyRegistrationsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-light border mt-3">
            <strong>How we calculated:</strong>
            <ul class="mb-0 small">
                <li><strong>Events by Program:</strong> Number of events held each month, grouped by program type</li>
                <li><strong>Registrations by Program:</strong> Number of confirmed registrations each month, grouped by program type</li>
            </ul>
        </div>
    </section>

    <section class="mb-5">
        <h2 class="h3 fw-bold mb-4 pb-2 border-bottom">Popular routes</h2>
        <div class="row g-4 mb-3">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <h3 class="fs-5 fw-medium mb-3">Top 20 most popular routes</h3>
                        <div style="height: 600px; position: relative;">
                            <canvas id="routesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-light border mt-3">
            <strong>How we calculated:</strong>
            <ul class="mb-0 small">
                <li><strong>Popularity Ranking:</strong> Based on number of confirmed registrations per route</li>
                <li><strong>Hover for details:</strong> See distance, elevation, and registration count for each route</li>
            </ul>
        </div>
    </section>

    <section class="mb-5">
        <h2 class="h3 fw-bold mb-4 pb-2 border-bottom">Programs overview</h2>
        <div class="row g-4 mb-3">
            <div class="col-lg-6 mx-auto">
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <canvas id="programsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-light border mt-3">
            <strong>How we calculated:</strong>
            <ul class="mb-0 small">
                <li><strong>Distribution:</strong> Events grouped by program type, showing percentage breakdown</li>
                <li><strong>Hover for details:</strong> See exact event count and percentage for each program</li>
            </ul>
        </div>
    </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    const monthlyLabels = {{ monthly_labels|safe }};
    const programs = {{ programs|safe }};
    const eventsByProgramMonthly = {{ events_by_program_monthly|safe }};
    const registrationsByProgramMonthly = {{ registrations_by_program_monthly|safe }};
    const topRoutesLabels = {{ top_routes_labels|safe }};
    const topRoutesCounts = {{ top_routes_counts|safe }};
    const topRoutesDetails = {{ top_routes_details|safe }};
    const programsLabels = {{ programs_labels|safe }};
    const programsCounts = {{ programs_counts|safe }};

    const programColors = [
        { bg: 'rgba(13, 110, 253, 0.7)', border: 'rgba(13, 110, 253, 1)' },
        { bg: 'rgba(25, 135, 84, 0.7)', border: 'rgba(25, 135, 84, 1)' },
        { bg: 'rgba(255, 193, 7, 0.7)', border: 'rgba(255, 193, 7, 1)' },
        { bg: 'rgba(220, 53, 69, 0.7)', border: 'rgba(220, 53, 69, 1)' },
        { bg: 'rgba(13, 202, 240, 0.7)', border: 'rgba(13, 202, 240, 1)' },
        { bg: 'rgba(108, 117, 125, 0.7)', border: 'rgba(108, 117, 125, 1)' }
    ];

    const monthlyEventsDatasets = programs.map((program, index) => ({
        label: program,
        data: eventsByProgramMonthly[program],
        backgroundColor: programColors[index % programColors.length].bg,
        borderColor: programColors[index % programColors.length].border,
        borderWidth: 2
    }));

    const monthlyEventsCtx = document.getElementById('monthlyEventsChart');
    new Chart(monthlyEventsCtx, {
        type: 'bar',
        data: {
            labels: monthlyLabels,
            datasets: monthlyEventsDatasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeInOutQuart'
            }
        }
    });

    const monthlyRegistrationsDatasets = programs.map((program, index) => ({
        label: program,
        data: registrationsByProgramMonthly[program],
        backgroundColor: programColors[index % programColors.length].bg,
        borderColor: programColors[index % programColors.length].border,
        borderWidth: 2
    }));

    const monthlyRegistrationsCtx = document.getElementById('monthlyRegistrationsChart');
    new Chart(monthlyRegistrationsCtx, {
        type: 'bar',
        data: {
            labels: monthlyLabels,
            datasets: monthlyRegistrationsDatasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeInOutQuart'
            }
        }
    });

    const routesCtx = document.getElementById('routesChart');
    new Chart(routesCtx, {
        type: 'bar',
        data: {
            labels: topRoutesLabels,
            datasets: [{
                label: 'Registrations',
                data: topRoutesCounts,
                backgroundColor: 'rgba(255, 193, 7, 0.7)',
                borderColor: 'rgba(255, 193, 7, 1)',
                borderWidth: 2
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        title: function(context) {
                            return topRoutesDetails[context[0].dataIndex].name;
                        },
                        label: function(context) {
                            const details = topRoutesDetails[context.dataIndex];
                            return [
                                'Registrations: ' + details.registrations,
                                'Distance: ' + details.distance.toFixed(1) + ' km',
                                'Elevation: ' + details.elevation.toFixed(0) + ' m'
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                y: {
                    ticks: {
                        autoSkip: false,
                        font: {
                            size: 11
                        }
                    }
                }
            },
            animation: false
        }
    });

    const programsCtx = document.getElementById('programsChart');
    new Chart(programsCtx, {
        type: 'doughnut',
        data: {
            labels: programsLabels,
            datasets: [{
                data: programsCounts,
                backgroundColor: [
                    'rgba(13, 110, 253, 0.7)',
                    'rgba(25, 135, 84, 0.7)',
                    'rgba(255, 193, 7, 0.7)',
                    'rgba(220, 53, 69, 0.7)',
                    'rgba(13, 202, 240, 0.7)',
                    'rgba(108, 117, 125, 0.7)'
                ],
                borderColor: [
                    'rgba(13, 110, 253, 1)',
                    'rgba(25, 135, 84, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(220, 53, 69, 1)',
                    'rgba(13, 202, 240, 1)',
                    'rgba(108, 117, 125, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    cornerRadius: 8,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + value + ' events (' + percentage + '%)';
                        }
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeInOutQuart'
            }
        }
    });
</script>
{% endblock %}
