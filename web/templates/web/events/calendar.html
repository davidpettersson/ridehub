{% extends 'web/_base_bootstrap.html' %}
{% block title %}{{ month_name }} {{ year }}{% endblock %}
{% block content %}
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <div class="d-flex align-items-center gap-1">
                    <a href="{% url 'calendar_month' prev_year prev_month %}" class="btn btn-light rounded-circle d-flex align-items-center justify-content-center calendar-nav-btn" style="width: 40px; height: 40px; border: none;" title="Previous month">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                    <a href="{% url 'calendar_month' next_year next_month %}" class="btn btn-light rounded-circle d-flex align-items-center justify-content-center calendar-nav-btn" style="width: 40px; height: 40px; border: none;" title="Next month">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </div>
                <h1 class="fs-4 fs-md-2 fw-bold mb-0 d-flex align-items-center gap-2">
                    <span>{{ month_name }} {{ year }}</span>
                    {% if year != today.year or month != today.month %}
                    <a href="{% url 'calendar_month' today.year today.month %}" class="btn btn-light rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; border: none;" title="Go to current month" aria-label="Go to current month">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </a>
                    {% endif %}
                </h1>
            </div>
            <div class="d-flex justify-content-end">
                <a href="{% url 'upcoming' %}" class="btn btn-light rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; border: none;" title="Switch to list view" aria-label="Switch to list view">
                    <i class="bi bi-list-ul"></i>
                </a>
            </div>
        </div>
        
        <div class="calendar-grid" x-data="{ selectedDay: 0 }">
            <div class="card">
                <div class="card-body p-0">
                    <table class="table table-bordered mb-0" style="table-layout: fixed;">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center py-2 d-none d-md-table-cell" style="width: 14.28%;">Sun</th>
                                <th class="text-center py-2 d-none d-md-table-cell" style="width: 14.28%;">Mon</th>
                                <th class="text-center py-2 d-none d-md-table-cell" style="width: 14.28%;">Tue</th>
                                <th class="text-center py-2 d-none d-md-table-cell" style="width: 14.28%;">Wed</th>
                                <th class="text-center py-2 d-none d-md-table-cell" style="width: 14.28%;">Thu</th>
                                <th class="text-center py-2 d-none d-md-table-cell" style="width: 14.28%;">Fri</th>
                                <th class="text-center py-2 d-none d-md-table-cell" style="width: 14.28%;">Sat</th>
                                <th class="text-center py-1 d-md-none" style="width: 14.28%; font-size: 0.7rem;"><abbr title="Sunday">S</abbr></th>
                                <th class="text-center py-1 d-md-none" style="width: 14.28%; font-size: 0.7rem;"><abbr title="Monday">M</abbr></th>
                                <th class="text-center py-1 d-md-none" style="width: 14.28%; font-size: 0.7rem;"><abbr title="Tuesday">T</abbr></th>
                                <th class="text-center py-1 d-md-none" style="width: 14.28%; font-size: 0.7rem;"><abbr title="Wednesday">W</abbr></th>
                                <th class="text-center py-1 d-md-none" style="width: 14.28%; font-size: 0.7rem;"><abbr title="Thursday">T</abbr></th>
                                <th class="text-center py-1 d-md-none" style="width: 14.28%; font-size: 0.7rem;"><abbr title="Friday">F</abbr></th>
                                <th class="text-center py-1 d-md-none" style="width: 14.28%; font-size: 0.7rem;"><abbr title="Saturday">S</abbr></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for week in month_days %}
                            <tr>
                                {% for day in week %}
                                <td class="p-0 calendar-day" style="vertical-align: top;">
                                    {% if day != 0 %}
                                        <!-- Desktop: full event details -->
                                        <div class="d-none d-md-block p-2" style="min-height: 96px;">
                                            <div class="d-flex justify-content-between align-items-start mb-1">
                                                <span class="fw-medium{% if day == today.day and month == today.month and year == today.year %} text-primary{% endif %}">{{ day }}</span>
                                            </div>
                                            {% for event_date, events in events_by_date.items %}
                                                {% if event_date.day == day %}
                                                    {% for event in events %}
                                                    <div class="mb-1">
                                                        <a href="{% url 'event_detail' event.id %}" class="text-decoration-none">
                                                            {% if event.starts_at.date < today %}
                                                            <div class="p-1 bg-white border rounded text-muted calendar-event"{% if event.program.color %} style="--program-color: {{ event.program.color }};"{% endif %} title="{{ event.name }} - {{ event.starts_at|date:'g:i A'|lower|cut:'.m.' }}{% if event.ends_at %} - {{ event.ends_at|date:'g:i A'|lower|cut:'.m.' }}{% endif %}">
                                                                <div class="fw-medium text-truncate" style="font-size: 0.65rem;">{{ event.starts_at|date:"g:i A"|lower|cut:".m." }}{% if event.ends_at %} - {{ event.ends_at|date:"g:i A"|lower|cut:".m." }}{% endif %}</div>
                                                                <div class="text-truncate" style="font-size: 0.75rem;">{{ event.name }}</div>
                                                                <div class="text-truncate"><span class="badge fw-normal text-muted" style="font-size: 0.6rem; background-color: {% if event.program.color %}{{ event.program.color }}1A{% else %}#6c757d1A{% endif %};">{% if event.program.emoji %}{{ event.program.emoji }} {% endif %}{{ event.program.name }}</span></div>
                                                            </div>
                                                            {% else %}
                                                            <div class="p-1 bg-white border rounded text-dark calendar-event"{% if event.program.color %} style="--program-color: {{ event.program.color }};"{% endif %} title="{{ event.name }} - {{ event.starts_at|date:'g:i A'|lower|cut:'.m.' }}{% if event.ends_at %} - {{ event.ends_at|date:'g:i A'|lower|cut:'.m.' }}{% endif %}">
                                                                <div class="fw-medium text-truncate" style="font-size: 0.65rem;">{{ event.starts_at|date:"g:i A"|lower|cut:".m." }}{% if event.ends_at %} - {{ event.ends_at|date:"g:i A"|lower|cut:".m." }}{% endif %}</div>
                                                                <div class="text-truncate" style="font-size: 0.75rem;">{{ event.name }}</div>
                                                                <div class="text-truncate"><span class="badge fw-normal text-muted" style="font-size: 0.6rem; background-color: {% if event.program.color %}{{ event.program.color }}1A{% else %}#6c757d1A{% endif %};">{% if event.program.emoji %}{{ event.program.emoji }} {% endif %}{{ event.program.name }}</span></div>
                                                            </div>
                                                            {% endif %}
                                                        </a>
                                                    </div>
                                                    {% endfor %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        <!-- Mobile: day number + colored dots -->
                                        <div class="d-md-none text-center calendar-day-mobile"
                                             role="button" tabindex="0"
                                             @click="selectedDay = selectedDay === {{ day }} ? 0 : {{ day }}"
                                             @keydown.enter.prevent="selectedDay = selectedDay === {{ day }} ? 0 : {{ day }}"
                                             @keydown.space.prevent="selectedDay = selectedDay === {{ day }} ? 0 : {{ day }}"
                                             :class="{ 'calendar-day-selected': selectedDay === {{ day }} }">
                                            <div class="calendar-day-number{% if day == today.day and month == today.month and year == today.year %} calendar-day-today{% endif %}">{{ day }}</div>
                                            <div class="calendar-dots">
                                                {% for event_date, events in events_by_date.items %}
                                                    {% if event_date.day == day %}
                                                        {% for event in events %}
                                                            <span class="calendar-dot{% if event_date < today %} calendar-dot-past{% endif %}" style="background-color: {{ event.program.color|default:'#6c757d' }};"></span>
                                                        {% endfor %}
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Mobile day detail panel -->
            {% for event_date, events in events_by_date.items %}
            <div class="d-md-none" x-cloak x-show="selectedDay === {{ event_date.day }}">
                {% for event in events %}
                <a href="{% url 'event_detail' event.id %}" class="calendar-day-detail text-decoration-none d-flex align-items-center gap-2">
                    <span class="calendar-dot-detail" style="background-color: {{ event.program.color|default:'#6c757d' }};"></span>
                    <div class="flex-grow-1" style="min-width: 0;">
                        <div class="fw-medium{% if event_date < today %} text-muted{% else %} text-dark{% endif %}" style="font-size: 0.875rem;">{{ event.name }}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">{{ event.starts_at|date:"g:i A"|lower|cut:".m." }}{% if event.ends_at %} – {{ event.ends_at|date:"g:i A"|lower|cut:".m." }}{% endif %} · {{ event.program.name }}</div>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                </a>
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <div class="mt-4 text-center">
            <p class="text-muted small mb-0">
                Subscribe to this calendar: 
                <a href="webcal://{{ request.get_host }}{% url 'event_feed' %}" 
                   class="text-decoration-none" 
                   title="Add to Apple Calendar on iPhone/iPad/Mac">iPhone/iPad</a>, 
                <a href="https://calendar.google.com/calendar/render?cid={{ request.build_absolute_uri }}{% url 'event_feed' %}" 
                   target="_blank" 
                   class="text-decoration-none" 
                   title="Add to Google Calendar (Android/Web)">Google Calendar</a>, 
                <a href="https://outlook.live.com/calendar/0/addfromweb?url={{ request.build_absolute_uri }}{% url 'event_feed' %}" 
                   target="_blank" 
                   class="text-decoration-none" 
                   title="Add to Microsoft 365 / Outlook Online">Outlook</a>, or 
                <a href="{% url 'event_feed' %}" 
                   class="text-decoration-none" 
                   title="Download ICS file for other calendar apps">other apps</a>
            </p>
        </div>
    </div>
{% endblock %}