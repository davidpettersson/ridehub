{% extends 'web/_base_bootstrap.html' %}
{% block title %}Riders for {{ event.name }}{% endblock %}
{% block content %}
<style media="print">
    /* Hide navbar and non-essential elements */
    nav, .navbar, .navbar-obc {
        display: none !important;
    }

    /* Ensure the event details card is visible */
    .mb-5 > .card.shadow-sm.p-4.mb-4 {
        display: block !important;
        border: 1px solid #ddd !important;
        margin-bottom: 15px !important;
    }

    /* Remove the card styling from table container only */
    .d-none.d-md-block.card.shadow-sm {
        border: none !important;
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    /* Remove padding from table container */
    .d-none.d-md-block.card > .p-4 {
        padding: 0 !important;
        margin: 0 !important;
    }

    /* Prevent page breaks within rows */
    tr {
        page-break-inside: avoid !important;
    }

    /* Prevent content from creating extra pages */
    html, body, main, .mb-5 {
        height: auto !important;
        min-height: 0 !important;
        max-height: none !important;
    }

    /* Remove all bottom margins/padding from all elements */
    * {
        margin-bottom: 0 !important;
    }

    /* Add page break control */
    @page {
        margin-bottom: 0 !important;
    }

    /* Force page break to avoid blank pages */
    .mb-5::after {
        content: "";
        display: block;
        page-break-after: always;
        height: 0;
    }

    /* Remove any footers */
    footer, .footer {
        display: none !important;
    }

    /* Print-specific styles */
    @page {
        size: landscape;
        margin: 0.5cm;
    }

    body {
        background-color: white !important;
        color: black !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    .container, .container-fluid, .container-lg, .container-md,
    .container-sm, .container-xl, .container-xxl {
        max-width: 100% !important;
        width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    .card {
        border: 1px solid #ddd !important;
        box-shadow: none !important;
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
    }

    .text-muted {
        color: #333 !important;
    }

    .badge {
        border: 1px solid #333 !important;
        color: black !important;
        background-color: white !important;
    }

    a {
        color: black !important;
        text-decoration: none !important;
    }

    .text-primary {
        color: black !important;
    }

    /* Hide non-essential elements */
    .d-md-none {
        display: none !important;
    }

    .d-none.d-md-block {
        display: block !important;
    }

    /* Table specific adjustments */
    .table {
        width: 100% !important;
        max-width: 100% !important;
    }

    .table th, .table td {
        border: 1px solid #ddd !important;
        padding: 4px !important;
        word-wrap: break-word !important;
    }

    /* Remove padding/margins */
    .mb-4, .mb-5, .py-4, .py-5, .p-4 {
        margin: 0 !important;
        padding: 0.2rem !important;
    }

    /* Adjust other layout elements */
    .overflow-auto {
        overflow: visible !important;
    }
</style>

<div class="mb-4">
    <div class="mb-4 d-print-none d-flex flex-wrap gap-2 align-items-center">
        <a href="{% url 'event_detail' event.id %}" class="btn btn-outline-secondary btn-sm rounded-pill d-inline-flex align-items-center">
            <i class="bi bi-arrow-left me-2"></i> Back to event details
        </a>
        {% if can_access_rider_contacts %}
        <span class="text-muted mx-1">|</span>
        <button class="btn btn-outline-info btn-sm rounded-pill d-inline-flex align-items-center copy-emails-btn" data-emails="{{ all_emails }}" data-type="all">
            <i class="bi bi-clipboard me-2"></i>
            Copy all rider emails
        </button>
        {% if ride_leader_emails %}
        <button class="btn btn-outline-info btn-sm rounded-pill d-inline-flex align-items-center copy-emails-btn" data-emails="{{ ride_leader_emails }}" data-type="leaders">
            <i class="bi bi-clipboard me-2"></i>
            Copy ride leader emails
        </button>
        {% endif %}
        {% endif %}
    </div>
    {% if can_access_rider_contacts %}
    <div id="copy-success-message" class="alert alert-success mb-3 small d-none d-print-none" role="alert">
        <i class="bi bi-check-circle me-2"></i>
        <span id="copy-success-text"></span>
    </div>
    {% endif %}

    <div class="mb-4">
        <div class="text-muted small mb-2">
            {{ event.starts_at|date:"l, F j" }} Â· {{ event.starts_at|date:"g:i A" }}{% if event.ends_at %} - {{ event.ends_at|date:"g:i A" }}{% if event.starts_at|date:"Y-m-d" != event.ends_at|date:"Y-m-d" %}<sup>+1</sup>{% endif %}{% endif %}
        </div>
        <h1 class="fs-2 fw-bold mb-2">
            {% if event.cancelled %}<span class="text-decoration-line-through">{{ event.name }}</span> (cancelled){% else %}{{ event.name }}{% endif %}
        </h1>
        <span class="badge fw-normal text-muted" style="font-size: 0.85rem; background-color: {% if event.program.color %}{{ event.program.color }}1A{% else %}#6c757d1A{% endif %};">{% if event.program.emoji %}{{ event.program.emoji }} {% endif %}{{ event.program }}</span>
    </div>

    {% if event.location or event.location_url %}
    <div class="card shadow-sm p-4 mb-4">
        <div class="d-flex flex-wrap gap-3 small">
                <div class="d-inline-flex align-items-center text-muted">
                    <i class="bi bi-geo-alt me-2"></i>
                    {% if event.location_url %}
                    <a href="{{ event.location_url }}"
                       class="text-primary text-decoration-underline d-flex align-items-center"
                       target="_blank" rel="noopener noreferrer">
                        {{ event.location }}
                        <i class="bi bi-box-arrow-up-right ms-1 small"></i>
                    </a>
                    {% else %}
                    <span>{{ event.location }}</span>
                    {% endif %}
                </div>
            </div>
    </div>
    {% endif %}

    {% if all_riders %}
    <h2 class="fs-5 fw-medium mb-3">Registered riders ({{ all_riders|length }})</h2>
        <!-- Mobile view (card-based layout) -->
        <div class="d-md-none">
            {% for rider_reg in all_riders %}
                <div class="card mb-3 p-4">
                    <div class="d-flex flex-column align-items-start mb-2">
                        <div class="d-flex align-items-center">
                            <h4 class="fw-medium fs-5 mb-0">{{ rider_reg.first_name }} {{ rider_reg.last_name }}</h4>
                            {% if rider_reg.ride_leader_preference == 'y' %}
                                <span class="badge bg-primary ms-2">Ride leader</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="small">
                        <div class="row mb-1">
                            <div class="col-5 fw-medium">Ride:</div>
                            <div class="col-7 text-muted">{{ rider_reg.ride.name|default:"N/A" }}</div>
                        </div>
                        <div class="row mb-1">
                            <div class="col-5 fw-medium">Speed group:</div>
                            <div class="col-7 text-muted">{{ rider_reg.speed_range_preference.range|default:"N/A" }}</div>
                        </div>

                        {% if can_access_rider_contacts %}
                        <div class="mt-3 border-top border-danger-subtle pt-2 w-100">
                            <div class="row mb-1">
                                <div class="col-5 fw-medium">Email:</div>
                                <div class="col-7 text-muted">
                                    <a href="mailto:{{ rider_reg.email }}" class="text-primary">
                                        {{ rider_reg.email }}
                                    </a>
                                </div>
                            </div>
                            <div class="row mb-1">
                                <div class="col-5 fw-medium">Phone:</div>
                                <div class="col-7 text-muted">
                                    <a href="tel:{{ rider_reg.phone }}" class="text-primary">
                                        {{ rider_reg.phone }}
                                    </a>
                                </div>
                            </div>
                            <div class="row mb-1">
                                <div class="col-5 fw-medium">Emergency:</div>
                                <div class="col-7 text-muted">{{ rider_reg.emergency_contact_name }}</div>
                            </div>
                            <div class="row mb-1">
                                <div class="col-5 fw-medium">Emergency phone:</div>
                                <div class="col-7 text-muted">
                                    <a href="tel:{{ rider_reg.emergency_contact_phone }}" class="text-primary">
                                        {{ rider_reg.emergency_contact_phone }}
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Desktop view (table-based layout) -->
        <div class="d-none d-md-block card shadow-sm overflow-auto">
            <div class="p-4">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col" class="small fw-medium">Name</th>
                            <th scope="col" class="small fw-medium">Ride</th>
                            <th scope="col" class="small fw-medium">Speed group</th>
                            {% if can_access_rider_contacts %}
                            <th scope="col" class="small fw-medium">Email</th>
                            <th scope="col" class="small fw-medium">Phone</th>
                            <th scope="col" class="emergency-info small fw-medium">Emergency contact</th>
                            <th scope="col" class="emergency-info small fw-medium">Emergency phone</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for rider_reg in all_riders %}
                            <tr>
                                <td class="small fw-medium">
                                    {{ rider_reg.first_name }} {{ rider_reg.last_name }}
                                    {% if rider_reg.ride_leader_preference == 'y' %}
                                        <span class="badge bg-primary ms-2">Ride leader</span>
                                    {% endif %}
                                </td>
                                <td class="small text-muted">{{ rider_reg.ride.name|default:"N/A" }}</td>
                                <td class="small text-muted">{{ rider_reg.speed_range_preference.range|default:"N/A" }}</td>
                                {% if can_access_rider_contacts %}
                                <td class="small text-muted">
                                    <a href="mailto:{{ rider_reg.email }}" class="text-primary">
                                        {{ rider_reg.email }}
                                    </a>
                                </td>
                                <td class="small text-muted">
                                    <a href="tel:{{ rider_reg.phone }}" class="text-primary">
                                        {{ rider_reg.phone }}
                                    </a>
                                </td>
                                <td class="emergency-info small text-muted">
                                    {{ rider_reg.emergency_contact_name }}
                                </td>
                                <td class="emergency-info small text-muted">
                                    <a href="tel:{{ rider_reg.emergency_contact_phone }}" class="text-primary">
                                        {{ rider_reg.emergency_contact_phone }}
                                    </a>
                                </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
    <h2 class="fs-5 fw-medium mb-3">Registered riders (0)</h2>
    <div class="py-5 text-center card">
        <p class="text-muted">No riders found for this event.</p>
    </div>
    {% endif %}
</div>

{% if can_access_rider_contacts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const copyButtons = document.querySelectorAll('.copy-emails-btn');
    const successMessage = document.getElementById('copy-success-message');
    const successText = document.getElementById('copy-success-text');

    copyButtons.forEach(button => {
        button.addEventListener('click', async function() {
            const emails = this.getAttribute('data-emails');
            const type = this.getAttribute('data-type');

            try {
                await navigator.clipboard.writeText(emails);

                const count = emails ? emails.split(',').length : 0;
                const label = type === 'all' ? 'rider' : 'ride leader';
                successText.textContent = `Copied ${count} ${label} email${count !== 1 ? 's' : ''} to clipboard!`;
                successMessage.classList.remove('d-none');

                setTimeout(() => {
                    successMessage.classList.add('d-none');
                }, 3000);
            } catch (err) {
                alert('Failed to copy emails. Please try again.');
            }
        });
    });
});
</script>
{% endif %}

{% endblock %}
